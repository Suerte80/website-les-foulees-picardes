{% set visited = visited|default([]) %}
{% set maxDepth = maxDepth|default(depth) %}

{% if maxDepth > 0 %}
    <ul class="tree">
        {% for item in items %}
            {% if item.id in visited %}
                <li><em>‚ö†Ô∏è Cycle d√©tect√© pour {{ item.name }} (id {{ item.id }})</em></li>
            {% else %}
                {% set visitedNext = visited|merge([item.id]) %}

                <li>
                    {# Ligne principale : nom + actions #}
                    <div class="tree-row">
                        {% if item.isFile %}
                            üìÑ <a href="{{ path('app_files_download', { id: item.id }) }}" data-turbo="false">{{ item.name }}</a>
                            {% if item.size is not null %}
                                <small>({{ (item.size / 1024)|number_format(1) }} ko)</small>
                            {% endif %}
                        {% else %}
                            üìÅ <strong>{{ item.name }}</strong>
                        {% endif %}

                        {# Bouton supprimer #}
                        <form method="post"
                              action="{{ path('app_files_delete', { id: item.id }) }}"
                              onsubmit="return confirm('Supprimer {{ item.isFile ? 'le fichier' : 'le dossier' }} ¬´ {{ item.name }} ¬ª ?');"
                              class="inline">
                            <input type="hidden" name="_method" value="DELETE">
                            <input type="hidden" name="_token" value="{{ csrf_token('delete' ~ item.id) }}">
                            <button class="btn-ghost">Supprimer</button>
                        </form>
                    </div>

                    {# Formulaire nouveau dossier (seulement si dossier) #}
                    {% if item.isFolder %}
                        <form action="{{ path('app_files_create_directory') }}" method="post" class="new-folder" data-turbo="false">
                            <input type="hidden" name="_token" value="{{ csrf_token('create_dir' ~ item.id) }}">
                            <input type="hidden" name="parent_id" value="{{ item.id }}">
                            <label for="name_{{ item.id }}">Nom :</label>
                            <input type="text" id="name_{{ item.id }}" name="name" required>
                            <button type="submit">Ajouter</button>
                        </form>
                        <a href="{{ path('app_files_download', { id: item.id }) }}" data-turbo="false">T√©l√©charger</a>

                        {# R√©cursion avec garde-fous : maxDepth et collection initialis√©e #}
                        {% if item.children is defined
                            and item.children is not empty
                            and (item.children.isInitialized ?? true) %}
                            {% include 'file/tree.html.twig' with {
                                items: item.children,
                                visited: visitedNext,
                                maxDepth: maxDepth - 1
                            } %}
                        {% endif %}
                    {% endif %}
                </li>
            {% endif %}
        {% else %}
            <li><em>Aucun √©l√©ment</em></li>
        {% endfor %}
    </ul>
{% endif %}
